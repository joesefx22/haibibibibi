<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† - Ø§Ø­Ø¬Ø²Ù„ÙŠ</title>
    
    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #1a7f46 0%, #145c32 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .payment-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            background: linear-gradient(135deg, #1a7f46, #145c32);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .payment-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .payment-header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .user-info {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .payment-content {
            padding: 30px;
        }

        .booking-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-right: 4px solid #1a7f46;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item.total {
            font-weight: bold;
            font-size: 18px;
            color: #1a7f46;
            border-top: 2px solid #1a7f46;
            padding-top: 15px;
            margin-top: 10px;
        }

        .discount-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .discount-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .discount-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }

        .discount-input input:focus {
            border-color: #1a7f46;
            outline: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1a7f46;
            color: white;
        }

        .btn-primary:hover {
            background: #145c32;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #1a7f46;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .payment-option.selected {
            border-color: #1a7f46;
            background: #f8fff9;
        }

        .payment-option i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .payment-option .option-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .payment-option .option-description {
            color: #666;
            font-size: 14px;
        }

        .paymob-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .paymob-logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .paymob-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .feature {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .feature i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .voucher-section {
            background: #e8f5e8;
            border: 2px dashed #1a7f46;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .voucher-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voucher-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #1a7f46;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            background: white;
        }

        .code-validation {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .validation-item.valid {
            color: #1a7f46;
        }

        .validation-item.invalid {
            color: #dc3545;
        }

        .payment-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-pay {
            flex: 1;
            background: #1a7f46;
            color: white;
            font-size: 18px;
            padding: 15px;
        }

        .btn-pay:hover {
            background: #145c32;
        }

        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a7f46;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .payment-status {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .status-success {
            color: #1a7f46;
        }

        .status-error {
            color: #dc3545;
        }

        .secure-badge {
            background: #1a7f46;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .free-booking {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .user-info-section {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-right: 3px solid #1a7f46;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .user-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .user-info-label {
            font-weight: bold;
            color: #555;
        }

        .user-info-value {
            color: #1a7f46;
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 10px;
            }
            
            .payment-content {
                padding: 20px;
            }
            
            .payment-options {
                grid-template-columns: 1fr;
            }
            
            .payment-actions {
                flex-direction: column;
            }
            
            .discount-input,
            .voucher-input {
                flex-direction: column;
            }
            
            .user-info {
                position: static;
                margin-bottom: 15px;
                text-align: center;
            }
            
            .user-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <div class="user-info" id="userInfoBadge">
                <i class="bi bi-person-circle me-1"></i>
                <span id="usernameDisplay">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
            <h1>ğŸš€ Ø§Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†</h1>
            <p>Ø£ÙƒÙ…Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø¬Ø² Ø¨Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†</p>
        </div>

        <div class="payment-content">
            <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
            <div class="alert" id="alertMessage"></div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div class="user-info-section" id="userInfoSection">
                <h5>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h5>
                <div class="user-info-grid" id="userInfoGrid">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² -->
            <div class="booking-summary" id="bookingSummary">
                <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h3>
                <div class="summary-items" id="summaryItems">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                </div>
            </div>

            <!-- Ù‚Ø³Ù… ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… -->
            <div class="discount-section">
                <h3>ğŸ« ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                <div class="discount-input">
                    <input type="text" id="discountCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…" maxlength="20">
                    <button class="btn btn-primary" onclick="validateDiscountCode()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯</button>
                </div>
                <div id="discountMessage"></div>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ -->
            <div class="free-booking" id="freeBookingSection" style="display: none;">
                <h3>ğŸ‰ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¯ÙØ¹!</h3>
                <p>Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…ØŒ Ø£ØµØ¨Ø­ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØµÙØ±.</p>
                <button class="btn btn-success" onclick="confirmFreeBooking()">
                    <i class="bi bi-check-circle me-2"></i>
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ù…Ø¬Ø§Ù†Ø§Ù‹
                </button>
            </div>

            <!-- Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ -->
            <div class="payment-methods" id="paymentMethodsSection">
                <h3>ğŸ’³ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h3>
                <div class="payment-options">
                    <div class="payment-option" onclick="selectPaymentMethod('online')" id="option-online">
                        <i class="bi bi-credit-card"></i>
                        <div class="option-name">Ø§Ù„Ø¯ÙØ¹ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
                        <div class="option-description">Ø¢Ù…Ù† ÙˆØ³Ø±ÙŠØ¹ Ø¹Ø¨Ø± Paymob</div>
                    </div>
                    <div class="payment-option" onclick="selectPaymentMethod('voucher')" id="option-voucher">
                        <i class="bi bi-upc-scan"></i>
                        <div class="option-name">Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„ÙƒÙˆØ¯</div>
                        <div class="option-description">Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø¯ÙØ¹</div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Paymob -->
            <div class="paymob-section" id="paymobSection">
                <div class="paymob-logo">
                    <i class="bi bi-credit-card"></i>
                </div>
                <h3 style="margin-bottom: 10px;">Paymob</h3>
                <p style="opacity: 0.9; margin-bottom: 20px;">Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù† Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø¦ØªÙ…Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
                
                <div class="paymob-features">
                    <div class="feature">
                        <i class="bi bi-shield-check"></i>
                        <span>Ø¢Ù…Ù† 100%</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-lightning"></i>
                        <span>Ø³Ø±ÙŠØ¹</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-phone"></i>
                        <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-headset"></i>
                        <span>Ø¯Ø¹Ù… ÙÙ†ÙŠ</span>
                    </div>
                </div>

                <button class="btn btn-primary" style="background: white; color: #667eea; font-size: 18px; padding: 15px 30px;" onclick="initiatePaymobPayment()">
                    <i class="bi bi-credit-card me-2"></i>
                    Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Paymob
                </button>

                <div class="secure-badge">
                    <i class="bi bi-shield-check"></i>
                    Ù…Ø´ÙØ± ÙˆÙ…Ø¤Ù…Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„ÙƒÙˆØ¯ -->
            <div class="voucher-section" id="voucherSection">
                <h3>ğŸ’³ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ù„Ø¹Ø¨. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø§ÙˆÙŠØ© Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†.
                </p>

                <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ -->
                <div class="voucher-input">
                    <input type="text" id="voucherCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹" maxlength="20">
                    <button class="btn btn-success" onclick="validateVoucher()">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
                </div>

                <!-- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ -->
                <div class="code-validation" id="codeValidation" style="display: none;">
                    <h6>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚:</h6>
                    <div class="validation-item" id="codeValidationStatus">
                        <i class="bi bi-dash-circle"></i>
                        <span>Ø§Ù„ÙƒÙˆØ¯: ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</span>
                    </div>
                    <div class="validation-item" id="totalValidation">
                        <i class="bi bi-dash-circle"></i>
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span id="requiredAmount">0</span> Ø¬Ù†ÙŠÙ‡</span>
                    </div>
                </div>

                <div id="voucherMessage"></div>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ -->
            <div class="payment-status" id="paymentStatus">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>

            <!-- Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...</p>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
            <div class="payment-actions">
                <a href="/" class="btn btn-secondary btn-back">
                    <i class="bi bi-arrow-right me-2"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
                <button class="btn btn-pay" id="confirmPaymentBtn" onclick="confirmPayment()" disabled>
                    <i class="bi bi-check-circle me-2"></i>
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentBooking = null;
        let appliedDiscount = null;
        let csrfToken = '';
        let paymobOrderId = null;
        let pollingInterval = null;
        let selectedPaymentMethod = null;
        let validatedVoucher = null;
        let pollingAttempts = 0;
        const MAX_POLLING_ATTEMPTS = 60; // 3 Ø¯Ù‚Ø§Ø¦Ù‚ (60 * 3 Ø«ÙˆØ§Ù†ÙŠ)
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
        const userId = localStorage.getItem('userId');
        const userRole = localStorage.getItem('userRole');
        const userEmail = localStorage.getItem('userEmail');
        const username = localStorage.getItem('username');

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¬Ù„Ø¨ Ù…Ø¹Ù„Ù…Ø§Øª URL (Ù…Ø«Ù„ booking_id)
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                bookingId: params.get('booking_id'),
                token: params.get('token'),
                paymentUrl: params.get('payment_url'),
                status: params.get('status')
            };
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function displayBookingDetails(details) {
            document.getElementById('field-name').textContent = details.field_name;
            document.getElementById('booking-date').textContent = new Date(details.booking_date).toLocaleDateString();
            document.getElementById('booking-time').textContent = `${details.start_time} - ${details.end_time}`;
            document.getElementById('total-amount').textContent = `${details.total_amount} Ø¬Ù†ÙŠÙ‡`;
            document.getElementById('deposit-amount').textContent = `${details.deposit_amount} Ø¬Ù†ÙŠÙ‡`;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            const remaining = details.total_amount - details.deposit_amount;
            document.getElementById('remaining-amount').textContent = `${remaining} Ø¬Ù†ÙŠÙ‡`;
            
            document.getElementById('payment-info').style.display = 'block';
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
        async function handleConfirmPayment(bookingId) {
            const btn = document.getElementById('confirmPaymentBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹...`;

            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ø¯ÙØ¹ Ù†Ø§Ø¬Ø­ Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
                const mockPaymentRef = `PAYREF-MOCK-${Date.now()}`; 

                // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ù€ Backend
                const result = await apiRequest('/api/booking/confirm-payment', 'POST', {
                    bookingId: bookingId,
                    paymentRef: mockPaymentRef
                });

                showAlert(result.message, 'success');
                
                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
                setTimeout(() => {
                    window.location.href = '/user.html?view=my-bookings';
                }, 3000);

            } catch (error) {
                showAlert(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ (Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø¬Ø§Ø­)';
            }
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† CSRF
        async function getCSRFToken() {
            try {
                const response = await fetch('/csrf-token', {
                    credentials: 'include'
                });
                const data = await response.json();
                csrfToken = data.csrfToken;
            } catch (error) {
                console.error('Error getting CSRF token:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²
        async function loadBookingInfo() {
            const { bookingId, paymentUrl, status } = getUrlParams();
            
            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ù† Paymob
            if (paymentUrl) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙÙˆØ±Ø§Ù‹
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-white" role="status"></div>
                        <h2 class="mt-4 text-white">Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø©...</h2>
                    </div>
                `;
                window.location.replace(paymentUrl);
                return;
            }
            
            // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Paymob
            if (status === 'success=true' || status === 'success=false') {
                const isSuccess = status === 'success=true';
                const bookingDetailsDiv = document.getElementById('bookingDetails');
                
                if (bookingDetailsDiv) bookingDetailsDiv.style.display = 'none'; 
                
                if (isSuccess) {
                    showPaymentStatus('Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹ ğŸ‰', 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ ÙˆØ¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    document.getElementById('paymentStatus').innerHTML += `<a href="/profile.html" class="btn btn-success mt-4">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</a>`;
                } else {
                    showPaymentStatus('ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ âŒ', 'ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'danger');
                    document.getElementById('paymentStatus').innerHTML += `<button class="btn btn-primary mt-4" onclick="handlePaymentCallback()">Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>`;
                }
                return;
            }
            
            // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ© Ø£Ùˆ ØªØ£ÙƒÙŠØ¯ Ø³Ø§Ø¨Ù‚)
            if (!bookingId) {
                showAlert('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø².', 'error');
                document.getElementById('loading').style.display = 'none';
                return;
            }

            try {
                showLoading(true);
                // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ù…Ù† Ø§Ù„Ù€ API Ø§Ù„Ù…Ø­Ù…ÙŠ
                const details = await apiRequest(`/api/booking/${bookingId}/details`, 'GET');
                
                if (details.status === 'booked_confirmed') {
                    showAlert('âœ… Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ù…Ø¤ÙƒØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø§Ù„Ø¢Ù†.', 'info');
                    setTimeout(() => {
                        window.location.href = '/user.html?view=my-bookings';
                    }, 2000);
                    return;
                }

                currentBooking = details;
                displayBookingSummary();
                displayUserInfo();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
                document.getElementById('requiredAmount').textContent = currentBooking.deposit_amount;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº ØµÙØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
                checkFreeBooking();
                
            } catch (error) {
                console.error('Error loading booking info:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function displayUserInfo() {
            if (!userId) {
                document.getElementById('userInfoSection').style.display = 'none';
                document.getElementById('userInfoBadge').style.display = 'none';
                showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
            document.getElementById('usernameDisplay').textContent = username || 'Ù…Ø³ØªØ®Ø¯Ù…';
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userInfoGrid = document.getElementById('userInfoGrid');
            userInfoGrid.innerHTML = `
                <div class="user-info-item">
                    <span class="user-info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                    <span class="user-info-value">${username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                    <span class="user-info-value">${userEmail || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                    <span class="user-info-value">${userId}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                    <span class="user-info-value">${userRole === 'admin' ? 'Ù…Ø¯ÙŠØ±' : userRole === 'vendor' ? 'Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©' : 'Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ'}</span>
                </div>
            `;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
        function checkFreeBooking() {
            if (currentBooking.deposit_amount <= 0) {
                document.getElementById('freeBookingSection').style.display = 'block';
                document.getElementById('paymentMethodsSection').style.display = 'none';
                document.getElementById('paymobSection').style.display = 'none';
                document.getElementById('voucherSection').style.display = 'none';
                document.getElementById('confirmPaymentBtn').style.display = 'none';
            } else {
                document.getElementById('freeBookingSection').style.display = 'none';
                document.getElementById('paymentMethodsSection').style.display = 'block';
            }
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
        async function confirmFreeBooking() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/confirm-free-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        bookingId: currentBooking.bookingId,
                        userId: userId,
                        method: 'free',
                        amount: 0
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showPaymentStatus('success', 'âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!');
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
                    await recordPaymentTransaction('free', 0);
                    
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²');
                }
                
            } catch (error) {
                console.error('Error confirming free booking:', error);
                showAlert(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²
        function displayBookingSummary() {
            const summaryItems = document.getElementById('summaryItems');
            
            const items = [
                { label: 'Ø§Ù„Ù…Ù„Ø¹Ø¨', value: currentBooking.field_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' },
                { label: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', value: new Date(currentBooking.booking_date).toLocaleDateString() },
                { label: 'Ø§Ù„ÙˆÙ‚Øª', value: `${currentBooking.start_time} - ${currentBooking.end_time}` },
                { label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', value: `${currentBooking.total_amount} Ø¬Ù†ÙŠÙ‡` },
                { label: 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†', value: `${currentBooking.deposit_amount} Ø¬Ù†ÙŠÙ‡` },
                { 
                    label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 
                    value: `${currentBooking.total_amount - currentBooking.deposit_amount} Ø¬Ù†ÙŠÙ‡`,
                    class: 'total'
                }
            ];
            
            summaryItems.innerHTML = items.map(item => `
                <div class="summary-item ${item.class || ''}">
                    <span>${item.label}:</span>
                    <span>${item.value}</span>
                </div>
            `).join('');
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            document.getElementById(`option-${method}`).classList.add('selected');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            if (method === 'online') {
                document.getElementById('paymobSection').style.display = 'block';
                document.getElementById('voucherSection').style.display = 'none';
                document.getElementById('confirmPaymentBtn').style.display = 'none';
                resetVoucherValidation(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆØ¯
            } else if (method === 'voucher') {
                document.getElementById('paymobSection').style.display = 'none';
                document.getElementById('voucherSection').style.display = 'block';
                document.getElementById('confirmPaymentBtn').style.display = 'block';
                resetVoucherValidation();
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØ­Ù‚Ù‚ Ø§Ù„ÙƒÙˆØ¯
        function resetVoucherValidation() {
            validatedVoucher = null;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('voucherCode').value = '';
            
            document.getElementById('codeValidationStatus').innerHTML = `
                <i class="bi bi-dash-circle"></i>
                <span>Ø§Ù„ÙƒÙˆØ¯: ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</span>
            `;
            
            document.getElementById('totalValidation').innerHTML = `
                <i class="bi bi-dash-circle"></i>
                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${currentBooking.deposit_amount} Ø¬Ù†ÙŠÙ‡</span>
            `;
            
            document.getElementById('codeValidation').style.display = 'block';
            document.getElementById('confirmPaymentBtn').disabled = true;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…
        async function validateDiscountCode() {
            const codeInput = document.getElementById('discountCode');
            const code = codeInput.value.trim().toUpperCase();
            const discountMessage = document.getElementById('discountMessage');
            
            if (!code) {
                discountMessage.innerHTML = '<p style="color: #dc3545;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…</p>';
                return;
            }
            
            if (!currentBooking || !currentBooking.pitchId) {
                discountMessage.innerHTML = '<p style="color: #dc3545;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</p>';
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/validate-discount-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        code: code,
                        pitchId: currentBooking.pitchId,
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    appliedDiscount = result;
                    discountMessage.innerHTML = `
                        <p style="color: #1a7f46;">
                            âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­! Ø®ØµÙ… ${result.value} Ø¬Ù†ÙŠÙ‡
                        </p>
                    `;
                    codeInput.disabled = true;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    currentBooking.deposit_amount = Math.max(0, currentBooking.deposit_amount - result.value);
                    displayBookingSummary();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
                    document.getElementById('requiredAmount').textContent = currentBooking.deposit_amount;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„Ø­Ø¬Ø² Ù…Ø¬Ø§Ù†ÙŠ
                    checkFreeBooking();
                    
                } else {
                    discountMessage.innerHTML = `<p style="color: #dc3545;">âŒ ${result.message || 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­'}</p>`;
                }
                
            } catch (error) {
                console.error('Error validating discount code:', error);
                discountMessage.innerHTML = '<p style="color: #dc3545;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</p>';
            } finally {
                showLoading(false);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹
        async function validateVoucher() {
            const codeInput = document.getElementById('voucherCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/validate-voucher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        voucherCode: code,
                        bookingId: currentBooking.bookingId,
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    validatedVoucher = {
                        code: code,
                        value: result.value
                    };
                    
                    updateVoucherValidationUI(result.value, true);
                    showAlert(`âœ… ÙƒÙˆØ¯ ØµØ§Ù„Ø­ - Ø§Ù„Ù‚ÙŠÙ…Ø©: ${result.value} Ø¬Ù†ÙŠÙ‡`, 'success');
                    
                } else {
                    validatedVoucher = null;
                    updateVoucherValidationUI(0, false);
                    showAlert(`âŒ ${result.message || 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­'}`, 'error');
                }
                
                checkPaymentReady();
                
            } catch (error) {
                console.error('Error validating voucher code:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© ØªØ­Ù‚Ù‚ Ø§Ù„ÙƒÙˆØ¯
        function updateVoucherValidationUI(value, isValid) {
            const validationElement = document.getElementById('codeValidationStatus');
            const icon = isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
            const text = isValid ? 'ØµØ§Ù„Ø­' : 'ØºÙŠØ± ØµØ§Ù„Ø­';
            
            validationElement.innerHTML = `
                <i class="bi ${icon}"></i>
                <span>Ø§Ù„ÙƒÙˆØ¯: ${value} Ø¬Ù†ÙŠÙ‡ - ${text}</span>
            `;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
            updateTotalValidation();
        }

        // ØªØ­Ø¯ÙŠØ« ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
        function updateTotalValidation() {
            const requiredAmount = currentBooking.deposit_amount;
            const isValid = validatedVoucher && validatedVoucher.value >= requiredAmount;
            const icon = isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
            const status = isValid ? 'Ù…ÙƒØªÙ…Ù„' : 'ØºÙŠØ± ÙƒØ§ÙÙŠ';
            
            document.getElementById('totalValidation').innerHTML = `
                <i class="bi ${icon}"></i>
                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${validatedVoucher ? validatedVoucher.value : 0} Ø¬Ù†ÙŠÙ‡ / Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${requiredAmount} Ø¬Ù†ÙŠÙ‡ - ${status}</span>
            `;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¯ÙØ¹
        function checkPaymentReady() {
            const isReady = validatedVoucher !== null && 
                          validatedVoucher.value >= currentBooking.deposit_amount;
            
            document.getElementById('confirmPaymentBtn').disabled = !isReady;
        }

        // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Paymob
        async function initiatePaymobPayment() {
            if (!currentBooking || !currentBooking.bookingId) {
                showAlert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const response = await apiRequest("/api/payment/initiate", 'POST', { 
                    bookingId: currentBooking.bookingId 
                });
                
                const { paymentToken, iframeId } = response;
                
                if (paymentToken && iframeId) {
                    // ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØµÙØ­Ø© Paymob iFrame Ù„Ù„Ø¯ÙØ¹
                    const paymobUrl = `https://accept.paymob.com/api/acceptance/iframes/${iframeId}?payment_token=${paymentToken}`;
                    window.location.href = paymobUrl;
                    
                } else {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ØµØ­ÙŠØ­.");
                }

            } catch (error) {
                console.error('Error initiating Paymob payment:', error);
                showAlert(`âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯
        async function confirmPayment() {
            if (selectedPaymentMethod !== 'voucher') {
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/confirm-voucher-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        voucherCode: validatedVoucher.code,
                        bookingId: currentBooking.bookingId,
                        userId: userId,
                        amount: currentBooking.deposit_amount
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showPaymentStatus('success', 'âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯! ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ.');
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
                    await recordPaymentTransaction('voucher', currentBooking.deposit_amount, [validatedVoucher.code]);
                    
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 3000);
                    
                } else {
                    throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹');
                }
                
            } catch (error) {
                console.error('Error confirming payment:', error);
                showAlert(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function recordPaymentTransaction(method, amount, voucherCodes = []) {
            try {
                await fetch('/api/record-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        bookingId: currentBooking.bookingId,
                        method: method,
                        amount: amount,
                        userId: userId,
                        voucherCodes: voucherCodes
                    })
                });
            } catch (error) {
                console.error('Error recording payment transaction:', error);
                // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø¹Ù…Ù„ÙŠØ© Ø«Ø§Ù†ÙˆÙŠØ©
            }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯ÙØ¹
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertMessage');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
        }

        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
        function showPaymentStatus(type, message) {
            const statusElement = document.getElementById('paymentStatus');
            statusElement.innerHTML = `
                <div class="status-${type}">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'x-circle'}" style="font-size: 48px;"></i>
                    <h3 style="margin: 15px 0;">${message}</h3>
                </div>
            `;
            statusElement.style.display = 'block';
        }

        // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Ø¯Ø§Ù„Ø© API Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ÙŠ)
        async function apiRequest(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'X-CSRF-Token': csrfToken
                },
                credentials: 'include'
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Request failed');
            }
            
            return await response.json();
        }

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'player') {
                showAlert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                setTimeout(() => {
                    window.location.href = '/auth.html';
                }, 2000);
                return;
            }
            
            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            displayUserInfo();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø©
            getCSRFToken();
            loadBookingInfo();
        });

        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
